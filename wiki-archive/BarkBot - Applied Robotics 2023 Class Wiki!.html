<!DOCTYPE html>
<!-- saved from url=(0042)https://eti4480.com/2023/index.php/BarkBot -->
<html class="client-js" lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>BarkBot - Applied Robotics 2023 Class Wiki!</title>
<script>document.documentElement.className="client-js";RLCONF={"wgBreakFrames":false,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"ZMs3QGB0qya7EKKK4uproQAAAAE","wgCSPNonce":false,"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"BarkBot","wgTitle":"BarkBot","wgCurRevisionId":1456,"wgRevisionId":1456,"wgArticleId":123,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":"Brad","wgUserGroups":["*","user","autoconfirmed"],"wgCategories":["Pages using deprecated source tags"],"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgRelevantPageName":"BarkBot","wgRelevantArticleId":123,"wgUserId":3,"wgUserEditCount":140,"wgUserRegistration":1672680976000,"wgIsProbablyEditable":true,"wgRelevantPageIsProbablyEditable":true,
"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgVectorDisableSidebarPersistence":false};RLSTATE={"site.styles":"ready","user.styles":"ready","user":"ready","user.options":"loading","ext.pygments":"ready","skins.vector.styles.legacy":"ready"};RLPAGEMODULES=["site","mediawiki.page.ready","mediawiki.toc","skins.vector.legacy.js","mediawiki.page.watch.ajax"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.implement("user.options@1i9g4",function($,jQuery,require,module){mw.user.tokens.set({"patrolToken":"510dc0c2af6c09f3e1265f8e65d5cd9f64cb3742+\\","watchToken":"606802f0d54c97e5e6a0e0c02dd989b964cb3742+\\","csrfToken":"a0021c62564a1d52143092cbbad551b464cb3742+\\"});mw.user.options.set({"VectorSkinVersion":"1","rcdays":"30","rcfilters-limit":"500","rcfilters-rc-collapsed":0,"rcfilters-saved-queries":"{\"queries\":{},\"version\":\"2\"}"});});});</script>
<link rel="stylesheet" href="./BarkBot - Applied Robotics 2023 Class Wiki!_files/load.php">
<script async="" src="./BarkBot - Applied Robotics 2023 Class Wiki!_files/load(1).php"></script>
<meta name="generator" content="MediaWiki 1.38.4">
<meta name="format-detection" content="telephone=no">
<link rel="alternate" type="application/x-wiki" title="Edit" href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit">
<link rel="shortcut icon" href="https://eti4480.com/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="https://eti4480.com/2023/opensearch_desc.php" title="Applied Robotics 2023 Class Wiki! (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://eti4480.com/2023/api.php?action=rsd">
<link rel="alternate" type="application/atom+xml" title="Applied Robotics 2023 Class Wiki! Atom feed" href="https://eti4480.com/2023/index.php?title=Special:RecentChanges&amp;feed=atom">
<style>
@media screen {
	.toctoggle{-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;font-size:94%}}</style></head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject mw-editable page-BarkBot rootpage-BarkBot skin-vector action-view skin-vector-legacy"><div id="mw-page-base" class="noprint"></div>
<div id="mw-head-base" class="noprint"></div>
<div id="content" class="mw-body" role="main">
	<a id="top"></a>
	<div id="siteNotice"></div>
	<div class="mw-indicators">
	</div>
	<h1 id="firstHeading" class="firstHeading mw-first-heading">BarkBot</h1>
	<div id="bodyContent" class="vector-body">
		<div id="siteSub" class="noprint">From Applied Robotics 2023 Class Wiki!</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="https://eti4480.com/2023/index.php/BarkBot#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="https://eti4480.com/2023/index.php/BarkBot#searchInput">Jump to search</a>
		<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr"><div class="mw-parser-output"><div style="float: right; margin: 0 0 1em 1em; width: auto; text-align: center; font-size: 95%; line-height: 1.4em; font-family: lucida grande, sans-serif;">
<div style="border: 1px solid #ccd2d9; width: 250px; background: #f9f9f9; text-align: left; padding: 0.5em 1em 0.5em 1em; text-align: center;">
<table style="background: transparent; text-align: left; table-layout: auto; border-collapse: collapse; padding: 0; font-size: 100%;" cellspacing="0" cellpadding="0" width="100%">

<tbody><tr>
<th colspan="2" style="padding: 0.2em 0 0.2em 0; background-color: goldenrod; text-align: center; font-size: larger;">BarkBot
</th></tr>
<tr>
<td colspan="2" style="padding: 0.2em 0 0.2em 0; text-align: center;"><a href="https://eti4480.com/2023/index.php/File:BarkBot_Cover.jpg" class="image"><img alt="BarkBot Cover.jpg" src="./BarkBot - Applied Robotics 2023 Class Wiki!_files/BarkBot_Cover.jpg" decoding="async" width="250" height="250"></a>
</td></tr>

<tr>
<th colspan="2" style="padding: 0.2em 0 0.2em 0; background-color: goldenrod; text-align: center; font-size: larger;">Description
</th></tr>
<tr>
<th style="border-top: solid 1px #ccd2d9; padding: 0.3em 1em 0.3em 0; vertical-align: top; text-align: left;">Brain:
</th>
<td style="border-top: solid 1px #ccd2d9; padding: 0.3em 0 0.3em 0; vertical-align: top;">Rasberry Pi 4
</td></tr>
<tr>
<th style="padding: 0.3em 1em 0.3em 0; vertical-align: top; text-align: left;">Sensors:
</th>
<td style="padding: 0.3em 0 0.3em 0; vertical-align: top;">Ultrasonic Rangefinder, Raspberry Pi Camera (OpenCV and TensorFlow)
</td></tr>
<tr>
<th style="padding: 0.3em 1em 0.3em 0; vertical-align: top; text-align: left;">Purpose:
</th>
<td style="padding: 0.3em 0 0.3em 0; vertical-align: top;">Collect and store dog toys
</td></tr>
<tr>
<th style="padding: 0.3em 1em 0.3em 0; vertical-align: top; text-align: left;">Designer(s):
</th>
<td style="padding: 0.3em 0 0.3em 0; vertical-align: top;">Brad Alvarez
</td></tr>
</tbody></table>
</div>
</div>
<p>Introducing the <b>BarkBot</b>, an autonomous dog toy collecting robot. This robot is designed to search for dog toys scattered around the house, using its sensors, arm, and gripper it can locate and pick up the toys and store them in a designated container. Its compact size and efficient movement allows it to navigate around obstacles and reach tight spaces, making sure no toy is left behind. This robot is not only a time saver for pet owners but also keeps the house tidy and organized.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="https://eti4480.com/2023/index.php/BarkBot#Problem_Statement"><span class="tocnumber">1</span> <span class="toctext">Problem Statement</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="https://eti4480.com/2023/index.php/BarkBot#Robot_Solution"><span class="tocnumber">2</span> <span class="toctext">Robot Solution</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="https://eti4480.com/2023/index.php/BarkBot#Robot_Specifications"><span class="tocnumber">3</span> <span class="toctext">Robot Specifications</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="https://eti4480.com/2023/index.php/BarkBot#Project_Schedule"><span class="tocnumber">4</span> <span class="toctext">Project Schedule</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="https://eti4480.com/2023/index.php/BarkBot#Weekly_Status_Updates"><span class="tocnumber">5</span> <span class="toctext">Weekly Status Updates</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="https://eti4480.com/2023/index.php/BarkBot#February_13,_2023"><span class="tocnumber">5.1</span> <span class="toctext">February 13, 2023</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="https://eti4480.com/2023/index.php/BarkBot#February_20,_2023"><span class="tocnumber">5.2</span> <span class="toctext">February 20, 2023</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="https://eti4480.com/2023/index.php/BarkBot#February_27,_2023"><span class="tocnumber">5.3</span> <span class="toctext">February 27, 2023</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="https://eti4480.com/2023/index.php/BarkBot#March_6,_2023"><span class="tocnumber">5.4</span> <span class="toctext">March 6, 2023</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="https://eti4480.com/2023/index.php/BarkBot#March_13,_2023"><span class="tocnumber">5.5</span> <span class="toctext">March 13, 2023</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="https://eti4480.com/2023/index.php/BarkBot#March_20,_2023"><span class="tocnumber">5.6</span> <span class="toctext">March 20, 2023</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="https://eti4480.com/2023/index.php/BarkBot#March_27,_2023"><span class="tocnumber">5.7</span> <span class="toctext">March 27, 2023</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="https://eti4480.com/2023/index.php/BarkBot#April_3,_2023"><span class="tocnumber">5.8</span> <span class="toctext">April 3, 2023</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-14"><a href="https://eti4480.com/2023/index.php/BarkBot#Robot_Schematics"><span class="tocnumber">6</span> <span class="toctext">Robot Schematics</span></a></li>
<li class="toclevel-1 tocsection-15"><a href="https://eti4480.com/2023/index.php/BarkBot#Robot_Source_Code"><span class="tocnumber">7</span> <span class="toctext">Robot Source Code</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="https://eti4480.com/2023/index.php/BarkBot#Main_Code"><span class="tocnumber">7.1</span> <span class="toctext">Main Code</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="https://eti4480.com/2023/index.php/BarkBot#Object_Detection_Code"><span class="tocnumber">7.2</span> <span class="toctext">Object Detection Code</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="https://eti4480.com/2023/index.php/BarkBot#Ultrasonic_Sensor_Hub_Code"><span class="tocnumber">7.3</span> <span class="toctext">Ultrasonic Sensor Hub Code</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="https://eti4480.com/2023/index.php/BarkBot#Servo_Controller_Code"><span class="tocnumber">7.4</span> <span class="toctext">Servo Controller Code</span></a></li>
<li class="toclevel-2 tocsection-20"><a href="https://eti4480.com/2023/index.php/BarkBot#Motor_Controller_Code"><span class="tocnumber">7.5</span> <span class="toctext">Motor Controller Code</span></a></li>
<li class="toclevel-2 tocsection-21"><a href="https://eti4480.com/2023/index.php/BarkBot#LCD_Driver"><span class="tocnumber">7.6</span> <span class="toctext">LCD Driver</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-22"><a href="https://eti4480.com/2023/index.php/BarkBot#Video_of_the_Robot"><span class="tocnumber">8</span> <span class="toctext">Video of the Robot</span></a></li>
<li class="toclevel-1 tocsection-23"><a href="https://eti4480.com/2023/index.php/BarkBot#Photos_of_the_Robot"><span class="tocnumber">9</span> <span class="toctext">Photos of the Robot</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Problem_Statement">Problem Statement</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=1" title="Edit section: Problem Statement">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>The problem of disorganization and clutter in households with pets is a common issue that many pet owners face. With dogs, in particular, it's not uncommon for them to have multiple toys, which can easily scatter around the house, creating a messy and cluttered environment. This not only makes it difficult to keep the house clean, but it can also be a tripping hazard for both pets and humans. A study by the American Pet Products Association found that 63% of US households own a pet, with dogs being the most popular pet. This means that a large portion of the population may be affected by the problem of disorganization and clutter of dog toys in their homes.
Manually picking up and organizing these toys can be time-consuming and tedious, especially for pet owners who have busy schedules or physical limitations. Additionally, some toys may be difficult to reach or in tight spaces, making it even more challenging to keep the house organized. As a result, many pet owners may find themselves neglecting this task, leading to a build-up of clutter over time.
</p>
<h2><span class="mw-headline" id="Robot_Solution">Robot Solution</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=2" title="Edit section: Robot Solution">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>The <b>BarkBot</b> is an autonomous robot on wheels designed to search for and pick up dog toys scattered around a house. It is equipped with a Raspberry Pi camera and image processing capabilities using OpenCV to identify and locate the toys. OpenCV is will trained on how dog toys look so it can identify any it sees. Once identified, it uses an ultrasonic sensor to measure the distance to the toys and navigate towards them while using its ultrasonic sensors to avoid obstacles. Once it reaches a toy, it uses a robotic arm with a gripper to pick it up and drop it in a container for storage. To identify the container, the robot will use its camera and look for a specific symbol on the container. It will repeat this until it has picked up all the dog toys in the area (small/medium sized room). The BarkBot is powered by a Raspberry Pi and uses Python for its code language. It can move around the house and cover a wide area, making it efficient and convenient for pet owners to keep their homes clutter-free. It is also designed to work independently. Overall, the robot is designed to make the task of keeping a house clean and tidy for pet owners more manageable and effortless.
</p>
<h2><span class="mw-headline" id="Robot_Specifications">Robot Specifications</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=3" title="Edit section: Robot Specifications">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table class="wikitable">
<tbody><tr>
<th>Quantity</th>
<th>Part Name</th>
<th>Description
</th></tr>
<tr>
<td>1</td>
<td>Raspberry Pi 4</td>
<td>Microprocessor
</td></tr>
<tr>
<td>1</td>
<td>Raspberry Pi Camera</td>
<td>Camera for identifying dog toys (OpenCV and TensorFlow)
</td></tr>
<tr>
<td>1</td>
<td>Raspberry Pi Servo HAT</td>
<td>add-on board that includes PWM pins for servos
</td></tr>
<tr>
<td>4</td>
<td>Ultrasonic Sensors</td>
<td>For obstacle avoidance
</td></tr>
<tr>
<td>1</td>
<td>USB Ultrasonic Sensor Controller</td>
<td>Hub for connecting Ultrasonic Sensors
</td></tr>
<tr>
<td>1</td>
<td>Robot Chassis Kit (includes Motors)</td>
<td>Platform for robot
</td></tr>
<tr>
<td>1</td>
<td>4WD L298N Motor Driver Board</td>
<td>Motor Controller
</td></tr>
<tr>
<td>1</td>
<td>Pack of Dupont Wires</td>
<td>For connecting sensors
</td></tr>
<tr>
<td>2</td>
<td>4.2V Rechargeable Battery</td>
<td>For powering robot
</td></tr>
<tr>
<td>1</td>
<td>16x2 LED Display</td>
<td>For displaying robot info
</td></tr>
<tr>
<td>1</td>
<td>Robot Arm Kit (includes servos)</td>
<td>Arm with gripper to pick up dog toys
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Project_Schedule">Project Schedule</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=4" title="Edit section: Project Schedule">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table class="wikitable">
<tbody><tr>
<th>Week</th>
<th>Date</th>
<th>Complete by date</th>
<th>Notes</th>
<th>Date Passed
</th></tr>
<tr>
<td>1</td>
<td>01/09</td>
<td></td>
<td>First day of class</td>
<td>Yes
</td></tr>
<tr>
<td>2</td>
<td>01/16</td>
<td></td>
<td>Dr. Martin Luther King Holiday</td>
<td>Yes
</td></tr>
<tr>
<td>3</td>
<td>01/23</td>
<td>Arduino Wiki Complete</td>
<td>Sensor Wiki Complete</td>
<td>Yes
</td></tr>
<tr>
<td>4</td>
<td>01/30</td>
<td>Order robot parts</td>
<td>Proposal Complete</td>
<td>Yes
</td></tr>
<tr>
<td>5</td>
<td>02/06</td>
<td>Have most if not all parts</td>
<td></td>
<td>Yes
</td></tr>
<tr>
<td>6</td>
<td>02/13</td>
<td>Ultrasonic sensors and bump sensors functioning</td>
<td>Milestone 1</td>
<td>Yes
</td></tr>
<tr>
<td>7</td>
<td>02/20</td>
<td>Camera and OpenCV functioning (able to detect dog toy) and LCD display functioning</td>
<td>Milestone 2</td>
<td>Yes
</td></tr>
<tr>
<td>8</td>
<td>02/27</td>
<td>Fully assembled platform with mostly everything mounted</td>
<td>Milestone 3</td>
<td>Yes
</td></tr>
<tr>
<td>9</td>
<td>03/06</td>
<td>Robot arm assembled and functioning</td>
<td></td>
<td>Yes
</td></tr>
<tr>
<td>10</td>
<td>03/13</td>
<td>Collision avoidance functioning</td>
<td>Milestone 4</td>
<td>Yes
</td></tr>
<tr>
<td>11</td>
<td>03/20</td>
<td>Robot arm mounted and functioning (able to pick up dog toy)</td>
<td></td>
<td>Yes
</td></tr>
<tr>
<td>12</td>
<td>03/27</td>
<td>Able to detect correct container for toy and drop it in</td>
<td>Milestone 5</td>
<td>Yes
</td></tr>
<tr>
<td>13</td>
<td>04/03</td>
<td>Iron out any remaining bugs</td>
<td></td>
<td>Yes
</td></tr>
<tr>
<td>14</td>
<td>04/10</td>
<td>Present in class</td>
<td>DEMO DAY!</td>
<td>Yes
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Weekly_Status_Updates">Weekly Status Updates</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=5" title="Edit section: Weekly Status Updates">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<h3><span id="February_13.2C_2023"></span><span class="mw-headline" id="February_13,_2023">February 13, 2023</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=6" title="Edit section: February 13, 2023">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>1) Progress made over the previous week</b>
</p><p>This past week I made progress on getting the Motor controller and ultrasonic sensors working with the Raspberry Pi. 
</p><p>Also, <b>MILESTONE 1</b> was completed (At least one sensor demoed functioning using the microcontroller)
</p><p>When the ultrasonic sensor detects a distance of 10cm or less, it triggers the Motor to stop. Demonstrating the ultrasonic sensor's ability to be used for obstacle avoidance. 
</p><p>Link to video of it in action: <a rel="nofollow" class="external free" href="https://www.youtube.com/watch?v=m5kUcWqdZ5k">https://www.youtube.com/watch?v=m5kUcWqdZ5k</a>
</p><p><b>2) Progress you intend to make over the coming week</b>
</p><p>This coming week I will work on the LCD display functioning and camera being able to detect dog toys using OpenCV
</p><p><b>3) Any problems or issues you encountered over the previous week</b>
</p><p>Some problems I ran into is my Robot HAT board for the Raspberry Pi not working. (Turns out it was defective so I purchased a different board)
</p><p>Another issue was very low FPS for the camera. This could be possibly be addressed with threading which I will look into into this coming week.
</p>
<h3><span id="February_20.2C_2023"></span><span class="mw-headline" id="February_20,_2023">February 20, 2023</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=7" title="Edit section: February 20, 2023">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>1) Progress made over the previous week</b>
</p><p>This past week I made a good amount of progress. I got the LCD display working and fixed the issues I was having with my ultrasonic sensors from last week (by using USB ultrasonic sensor hub). I also built the car chassis and attached most of the parts to it (Robot arm, raspberry pi, ultrasonic sensors, and motor controller). I was unable to make any progress on the camera since the camera I had stopped working and the new one I ordered never arrived (its arriving this week). 
</p><p>Also, <b>MILESTONE 2</b> was completed (LCD display working)
</p><p>The LCD displays my name and the robots name when booting up. It will also be able to display the status of the robot.
</p><p>Link to video of it in action (LCD working and very crude obstacle avoidance): <a rel="nofollow" class="external free" href="https://www.youtube.com/watch?v=iZy9qZAvzFM">https://www.youtube.com/watch?v=iZy9qZAvzFM</a>
</p><p><b>2) Progress you intend to make over the coming week</b>
</p><p>This coming week I will actually work on the camera being able to detect dog toys using OpenCV
</p><p><b>3) Any problems or issues you encountered over the previous week</b>
</p><p>Some issues I've encountered this week was getting the USB ultrasonic Hub to work (it uses USB serial which was a pain but I ended up getting it to work).
</p><p>My Raspberry Pi camera stopped working (I ordered a new one but it never arrived, so now its arriving this coming week) so I was unable to make any progress on the camera and OpenCV.
</p><p>Also, I've been getting low voltage warnings on my Raspberry Pi causing it to throttle and heat up. I will try to address this by purchasing a new USB C cable that can allow for more amps.
</p>
<h3><span id="February_27.2C_2023"></span><span class="mw-headline" id="February_27,_2023">February 27, 2023</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=8" title="Edit section: February 27, 2023">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>1) Progress made over the previous week</b>
</p><p>This past week I finally made some progress on the camera and OpenCV. I took over 70+ pictures of two dog toy balls (will work on more toys) and labeled where the toys where in each picture and put it through TensorFlow object detection training (3 hours of training). After exporting the model and putting it on the Raspberry Pi with OpenCV and TensorFlow Lite, it was able to identify the balls with decent confidence. However, the FPS is lower than I had hoped (~3 FPS) but Im kinda hitting the limit of what the Pi can do.
</p><p>Link to video of Object Detection working: <a rel="nofollow" class="external free" href="https://www.youtube.com/watch?v=IWmnCW4bHGc">https://www.youtube.com/watch?v=IWmnCW4bHGc</a>
</p><p>Also, <b>MILESTONE 3</b> was <i>somewhat</i> completed (Mounted most components, still missing permanent mount for camera and LCD)
</p><p><b>2) Progress you intend to make over the coming week</b>
</p><p>This coming week I will work on the robotic arm being able to grab the toys and possibly try to increase FPS (maybe overclocking the Pi?)
</p><p><b>3) Any problems or issues you encountered over the previous week</b>
</p><p>Some issues I've encountered this week was getting the object detection to work at a <i>reasonable</i> FPS. I first tried training with a YOLO model but it is way to heavy for the Pi. (It was running at 0.3 FPS lol). I then tried TensorFlow Lite (a lighter version of TenserFlow) and was able to get about 3 FPS. Still not as much as I hoped but maybe I can try overclocking the Pi?
</p>
<h3><span id="March_6.2C_2023"></span><span class="mw-headline" id="March_6,_2023">March 6, 2023</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=9" title="Edit section: March 6, 2023">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>1) Progress made over the previous week</b>
</p><p>This past week I made some progress on the Robot arm and TensorFlow. The BarkBot is now able to drive itself up to a toy when it identifies one and pick it up with the Robot arm (somewhat). I ended up using the bounding box dimensions from TenserFlow and OpenCV to calculate the distance of the toy from the camera. (will try to improve accuracy). Using this, the Barkbot can drive up to the toy while trying to keep the toy in the center of the camera (with the cameras processing latency, this causes the robot to move left to right a lot) and use a pre-programmed move of the Robot arm to pick it up.
</p><p>Here is a link to it in action: <a rel="nofollow" class="external free" href="https://www.youtube.com/watch?v=3wlqFhwRFRE">https://www.youtube.com/watch?v=3wlqFhwRFRE</a>
</p><p>Also this week, I was able to improve the FPS of the camera by switching to a 64 bit version of Raspbian OS instead of 32 bit (from ~3 to ~7 FPS!). I also discovered that I can squeeze a bit more FPS if I turn off VNC (the remote desktop software) and disabling the desktop environment which I will most likely do for the final version of the Barkbot.
</p><p><b>2) Progress you intend to make over the coming week</b>
</p><p>This coming week I will work on Collision Avoidance since right now it will only stop once the toy is in pickup range or something is too close to the ultrasonic sensors. I will also try to mount the camera more permanently instead of using tape.
</p><p><b>3) Any problems or issues you encountered over the previous week</b>
</p><p>I didn't encounter too many issues this week other than writing the logic for getting the toy in the perfect position for pickup (still not amazing since motor don't have encoders) which was a pain but I will try to improve it. Also, I ordered different dog toys for the robot to be able to pick up other toys than just balls but the ones that I ordered where too big so I will look into getting smaller ones.
</p>
<h3><span id="March_13.2C_2023"></span><span class="mw-headline" id="March_13,_2023">March 13, 2023</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=10" title="Edit section: March 13, 2023">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>1) Progress made over the previous week</b>
</p><p>This past week I made some progress on the Obstacle Avoidance. The Barkbot is able to move around on its own and avoid obstacles using its ultrasonic sensors. 
</p><p>This means that <b>MILESTONE 4</b> is complete.
</p><p>Here is a link to it in action: <a rel="nofollow" class="external free" href="https://www.youtube.com/watch?v=28ZaDn5rXmI">https://www.youtube.com/watch?v=28ZaDn5rXmI</a>
</p><p><b>2) Progress you intend to make over the coming week</b>
</p><p>This coming week I will work on the QRCode detection for the bin that the BarkBot will drop the toys in. Also, I want to add the batteries so that the robot can move without having it be connected to power with a cable. Lastly, I want to clean and smooth out some of the code for the toy pickup and obstacle avoidance and merge those two systems together. 
</p><p><b>3) Any problems or issues you encountered over the previous week</b>
</p><p>The problem I initially encountered was when I ran the ultrasonic detection on its own thread (since it is running off the USB controller so the serial needs to be read) but my camera FPS performance tanked and I lost about 3 - 4 FPS. So, I ended up running the ultrasonic on the same thread as the camera which is good enough since the FPS is around 6 - 7 and that gives about 140 - 150 ms per loop which is enough for obstacle avoidance.
</p>
<h3><span id="March_20.2C_2023"></span><span class="mw-headline" id="March_20,_2023">March 20, 2023</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=11" title="Edit section: March 20, 2023">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>1) Progress made over the previous week</b>
</p><p>This past week I made some progress getting the ultrasonic sensor logic and toy detection logic working together and cleaning up some code (still not great). I also got QRCode detection working for the toy bin. Barkbot can now look for a toy, pick it up, look for the QRCode on the bin, go to the bin and drop the toy. This only works if the bot is in a specific location since it doesnt really search for it other than going in a circle.
</p><p>Here is a link to it in action: <a rel="nofollow" class="external free" href="https://www.youtube.com/watch?v=tBVK-y55Duc">https://www.youtube.com/watch?v=tBVK-y55Duc</a>
</p><p><b>2) Progress you intend to make over the coming week</b>
</p><p>This coming week I will work on getting all the systems working together a lot better and cleaning up VERY sloppy code. Also, I want to get the bot to go into a better "searching pattern" to look for the toy and QRCode.
</p><p><b>3) Any problems or issues you encountered over the previous week</b>
</p><p>The problem I initially encountered was the camera was unable to identify QRCodes while moving due to smearing. So the "searching pattern" had to be channged to move in a certain direction, stop momentarly, and continue. This allows a moment for the camera to see if there is a QRCode in the frame. It still not great a seeing QRCodes from far but works at a decent range. Also, the code is VERY sloppy and only works in certain conditions. Will work on improving this.
</p>
<h3><span id="March_27.2C_2023"></span><span class="mw-headline" id="March_27,_2023">March 27, 2023</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=12" title="Edit section: March 27, 2023">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>1) Progress made over the previous week</b>
</p><p>This past week I made some progress getting some sort of "searching pattern" for the robot. It's not ideal but it basically goes in a circle (stopping momentarily and continuing) for a set amount of time then goes stright for a set amount of time, then repeats. It somewhat random so it misses the toys and QRCode on the box when "searching" quite a lot so its not the best. This past week I also worked on permanently mounting a couple of components (Camera, LCD display, power switch, and battery). 
</p><p><b>MILESTONE 5</b> was completed as well (being able to detect box with QRCode and drop toy)
</p><p>Here is a link to it in action: <a rel="nofollow" class="external free" href="https://www.youtube.com/watch?v=hn5GnFuFguE">https://www.youtube.com/watch?v=hn5GnFuFguE</a>
</p><p><b>2) Progress you intend to make over the coming week</b>
</p><p>We are apporaching the end so this coming week I want to train the TenserFlow model for the last time on more different colored balls (Hopefully this makes the model better since it tends to miss the balls a decent amount). I want to also get the LCD display working, showing the status of the robot (right now it only shows the local IP of the network its connected to). And I want to "improve" the "searching pattern" since it can take a long time for it to find the toys and lastly, iron out some bugs I've been experiencing.
</p><p><b>3) Any problems or issues you encountered over the previous week</b>
</p><p>Some problems encountered this past week was QRCode detection is still not great (might be the low resolution on the camera?), I might consider changing it to a specific symbol and training the TenserFlow model to detect it that symbol. Also, some bugs where it would stop searching and just sit there and do nothing and output no errors (Its something with my code, will fix this coming week).
</p>
<h3><span id="April_3.2C_2023"></span><span class="mw-headline" id="April_3,_2023">April 3, 2023</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=13" title="Edit section: April 3, 2023">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>1) Progress made over the previous week</b>
</p><p>This past week I made some progress on being able to detect more colored toys and now i'm utilizing a "target" symbol on the drop bin so the BarkBot can detect where the bin is more consistently (still not the best). I also worked on the LCD being able to display the current status of the BarkBot (Searching, Found Toy, Picking Up Toy, Found Bin, and Dropping Toy).
</p><p>Here is a link to it in action with the LCD Display: <a rel="nofollow" class="external free" href="https://www.youtube.com/watch?v=GzQP1WTRHLA">https://www.youtube.com/watch?v=GzQP1WTRHLA</a>
</p><p><b>2) Progress you intend to make over the coming week</b>
</p><p>This is the last week so I want to make finishing touches. I might refine the TensorFlow model once more since it still sometimes detects random stuff as toys. I also want to squash remaining bugs, refine the code, and do a lot of trial runs to make sure it works consistantly.
</p><p><b>3) Any problems or issues you encountered over the previous week</b>
</p><p>The TensorFlow model still sometimes detects random stuff as toys so I might refine the TensorFlow model once more this coming week. Also, some weird bugs and bad looking code still remains so I will refine that and hopefully everything will be as good as it can be for DEMO DAY.
</p>
<h2><span class="mw-headline" id="Robot_Schematics">Robot Schematics</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=14" title="Edit section: Robot Schematics">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p><a href="https://eti4480.com/2023/index.php/File:Schematic_BarkBot_2023-04-17.png" class="image"><img alt="Schematic BarkBot 2023-04-17.png" src="./BarkBot - Applied Robotics 2023 Class Wiki!_files/1200px-Schematic_BarkBot_2023-04-17.png" decoding="async" width="1200" height="1045" srcset="/2023/images/thumb/d/db/Schematic_BarkBot_2023-04-17.png/1800px-Schematic_BarkBot_2023-04-17.png 1.5x, /2023/images/d/db/Schematic_BarkBot_2023-04-17.png 2x"></a>
</p>
<h2><span class="mw-headline" id="Robot_Source_Code">Robot Source Code</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=15" title="Edit section: Robot Source Code">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<h3><span class="mw-headline" id="Main_Code">Main Code</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=16" title="Edit section: Main Code">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="kn">from</span> <span class="nn">MotorController</span> <span class="kn">import</span> <span class="n">Motor</span>
<span class="kn">from</span> <span class="nn">ServoDriver</span> <span class="kn">import</span> <span class="n">Servo</span>
<span class="kn">from</span> <span class="nn">UltraSerial</span> <span class="kn">import</span> <span class="n">Ultrasonic</span>
<span class="kn">from</span> <span class="nn">LCDDriver</span> <span class="kn">import</span> <span class="n">LCD</span>
<span class="kn">from</span> <span class="nn">Object_Detect</span> <span class="kn">import</span> <span class="n">ObjectDetect</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span> <span class="c1">#python library</span>
<span class="kn">import</span> <span class="nn">cv2</span> <span class="c1">#openCV library</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="c1">#python library</span>

<span class="k">class</span> <span class="nc">BarkBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_fps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_gui</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_conf</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">disable_motors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span> <span class="o">=</span> <span class="n">LCD</span><span class="p">(</span><span class="mh">0x27</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">lcd_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">lcd_display_string</span><span class="p">(</span><span class="s2">"BarkBot"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">lcd_display_string</span><span class="p">(</span><span class="s2">"by Brad Alvarez"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#add waits for setup so PI doesn't crash due to overcurrent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arm</span> <span class="o">=</span> <span class="n">Servo</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">car</span> <span class="o">=</span> <span class="n">Motor</span><span class="p">(</span><span class="n">disable</span><span class="o">=</span><span class="n">disable_motors</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span> <span class="o">=</span> <span class="n">ObjectDetect</span><span class="p">(</span><span class="n">show_gui</span><span class="o">=</span><span class="n">show_gui</span><span class="p">,</span> <span class="n">min_conf_threshold</span><span class="o">=</span><span class="n">min_conf</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span> <span class="o">=</span> <span class="n">Ultrasonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">UltraAvoidanceSetup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_ultra_range</span> <span class="o">=</span> <span class="mi">190</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FR_ultra_range</span> <span class="o">=</span> <span class="mi">140</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FL_ultra_range</span> <span class="o">=</span> <span class="mi">140</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B_ultra_range</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickup_thread</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_thread</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_thread</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backwards_thread</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writing_to_display</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deteced_ultra</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">armHasObject</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_right</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doCleanup</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_fps</span> <span class="o">=</span> <span class="n">show_fps</span>
        <span class="k">if</span> <span class="n">show_fps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_rate_calc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTickFrequency</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">getSpeedforDist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">50</span>
        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">45</span>
        <span class="k">return</span> <span class="mi">55</span>
            
    <span class="k">def</span> <span class="nf">inRange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">negval</span><span class="p">,</span> <span class="n">posval</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="n">negval</span> <span class="ow">and</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">posval</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">foundObject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickup_thread</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">foundBin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_thread</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>  
        <span class="k">return</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">setMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode_string</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">mode_string</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">writing_to_display</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode_string</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writing_to_display</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">writeLCD</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">mode_string</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">writeLCD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">lcd_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">lcd_display_string</span><span class="p">(</span><span class="s2">"BarkBot"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">lcd_display_string</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writing_to_display</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">checkUltras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_ultra_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deteced_ultra</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_ultra_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deteced_ultra</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FR_ultra_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deteced_ultra</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_right</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FL_ultra_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deteced_ultra</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_right</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deteced_ultra</span> <span class="o">=</span> <span class="kc">False</span>
            
    <span class="k">def</span> <span class="nf">checkIfPickupRange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s2">"Found Toy"</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">)):</span> <span class="c1">#x_error check</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_right</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.18</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
               
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_left</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.18</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">)):</span> <span class="c1">#distance check</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">6.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_backwards</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.10</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">6.5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_foward</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.13</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s2">"Picking Up Toy"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arm</span><span class="o">.</span><span class="n">doPickup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">armHasObject</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setSearch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickup_thread</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">checkIfDropRange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s2">"Found Bin"</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">)):</span> <span class="c1">#x_error check</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_right</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.18</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
               
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_left</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.18</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span> <span class="c1">#distance check</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_foward</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s2">"Dropping Toy"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arm</span><span class="o">.</span><span class="n">doDrop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">armHasObject</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_thread</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">checkifFoundObject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickup_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s2">"Found Toy"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetSearch</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Avoided</span><span class="p">():</span>
                <span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpeedforDist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pickup_thread</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checkIfPickupRange</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">())</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_backwards</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_foward</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_right</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_left</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickup_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s2">"Searching..."</span><span class="p">)</span>
                              
    <span class="k">def</span> <span class="nf">checkiffoundBin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s2">"Found Bin"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetSearch</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Avoided</span><span class="p">():</span>
                <span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpeedforDist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_thread</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checkIfDropRange</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_foward</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">found_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_right</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_left</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="s2">"Searching..."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">doingSearchObject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">foundObject</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Search</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_thread</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">doingSearchBin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">foundBin</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Search</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_thread</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">Search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_ultra_range</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_ultra_range</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_right</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_right</span><span class="p">(</span><span class="mi">65</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_left</span><span class="p">(</span><span class="mi">65</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_ultra_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_backwards</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_ultra_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_foward</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Avoided</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_thread</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_ultra_range</span><span class="p">:</span> <span class="c1">#detected on front middle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backwards_thread</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backwardsAvoid</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_ultra_range</span><span class="p">:</span> <span class="c1">#detected on back</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_foward</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FL_ultra_range</span><span class="p">:</span> <span class="c1">#detected on front left</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_right</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_right</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FR_ultra_range</span><span class="p">:</span> <span class="c1">#detected on front right</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_left</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_right</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        
    <span class="k">def</span> <span class="nf">carControlBin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">foundBin</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_thread</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">search_thread</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doingSearchBin</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backwards_thread</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Avoided</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_foward</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
                    
    <span class="k">def</span> <span class="nf">carControlObject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">foundObject</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_thread</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">search_thread</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doingSearchObject</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backwards_thread</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Avoided</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_foward</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
                    
    <span class="k">def</span> <span class="nf">backwardsAvoid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_ultra_range</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_ultra_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">go_backwards</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_left</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_right</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">turn_right</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_right</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">backwards_thread</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">toggleSearch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span> <span class="c1">#do search for about 3 seconds (8-9 FPS)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span> <span class="c1">#go straight for about 8 seconds (8-9 FPS)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">+</span> <span class="mi">1</span>
                
    <span class="k">def</span> <span class="nf">resetSearch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">setSearch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doSearch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchCount</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doCleanup</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">car</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">lcd_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">lcd_display_string</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
<span class="n">robot</span> <span class="o">=</span> <span class="n">BarkBot</span><span class="p">(</span><span class="n">show_fps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_gui</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_conf</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">disable_motors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#robot object setup</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1">#main loop</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">show_fps</span><span class="p">:</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTickCount</span><span class="p">()</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">ultra</span><span class="o">.</span><span class="n">receiveUltra</span><span class="p">()</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">checkUltras</span><span class="p">()</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">objdetect</span><span class="o">.</span><span class="n">doObjectDetect</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">armHasObject</span><span class="p">:</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">checkiffoundBin</span><span class="p">()</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">carControlBin</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">checkifFoundObject</span><span class="p">()</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">carControlObject</span><span class="p">()</span>
            <span class="n">robot</span><span class="o">.</span><span class="n">toggleSearch</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">show_fps</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'FPS: </span><span class="si">{0:.2f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">frame_rate_calc</span><span class="p">))</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTickCount</span><span class="p">()</span>
                <span class="n">time1</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">/</span><span class="n">robot</span><span class="o">.</span><span class="n">freq</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">frame_rate_calc</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">time1</span>
    
<span class="k">except</span><span class="p">:</span> <span class="c1">#KeyboardInterrupt: # If there is a KeyboardInterrupt (when you press ctrl+c), exit the program</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Exception"</span><span class="p">)</span>
    <span class="n">robot</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="s2">"Exception"</span><span class="p">)</span>
</pre></div>
<h3><span class="mw-headline" id="Object_Detection_Code">Object Detection Code</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=17" title="Edit section: Object Detection Code">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>Originally provided by <a rel="nofollow" class="external text" href="https://github.com/EdjeElectronics/TensorFlow-Lite-Object-Detection-on-Android-and-Raspberry-Pi/blob/master/TFLite_detection_webcam.py">EdjeElectronics</a> but had to be significantly rewritten to support python classes, getting object distance, and sorting multiple found objects by distance
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">pyzbar</span> <span class="kn">import</span> <span class="n">pyzbar</span>
<span class="kn">import</span> <span class="nn">importlib.util</span>

<span class="k">class</span> <span class="nc">VideoStream</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">416</span><span class="p">,</span><span class="mi">416</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FOURCC</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">'MJPG'</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          
        <span class="bp">self</span><span class="o">.</span><span class="n">grabbed</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_180</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">())</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">return</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">grabbed</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_180</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="kc">True</span>
        
<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="s1">'custom_model_lite_updated'</span>
<span class="n">GRAPH_NAME</span> <span class="o">=</span> <span class="s1">'detect.tflite'</span>
<span class="n">LABELMAP_NAME</span> <span class="o">=</span> <span class="s1">'labelmap.txt'</span>
<span class="n">knownHeights</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">#in inches</span>
  <span class="s2">"blue-ball"</span><span class="p">:</span> <span class="mf">1.9</span><span class="p">,</span>
  <span class="s2">"green-ball"</span><span class="p">:</span> <span class="mf">1.9</span><span class="p">,</span>
  <span class="s2">"orange-ball"</span><span class="p">:</span> <span class="mf">1.9</span><span class="p">,</span>
  <span class="s2">"yellow-ball"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">"red-ball"</span><span class="p">:</span> <span class="mf">1.9</span><span class="p">,</span>
  <span class="s2">"drop-bin"</span><span class="p">:</span> <span class="mf">3.375</span>
<span class="p">}</span>

<span class="n">pkg</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s1">'tflite_runtime'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">pkg</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tflite_runtime.interpreter</span> <span class="kn">import</span> <span class="n">Interpreter</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tensorflow.lite.python.interpreter</span> <span class="kn">import</span> <span class="n">Interpreter</span>
  
<span class="n">CWD_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">PATH_TO_CKPT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CWD_PATH</span><span class="p">,</span><span class="n">MODEL_NAME</span><span class="p">,</span><span class="n">GRAPH_NAME</span><span class="p">)</span>
<span class="n">PATH_TO_LABELS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CWD_PATH</span><span class="p">,</span><span class="n">MODEL_NAME</span><span class="p">,</span><span class="n">LABELMAP_NAME</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PATH_TO_LABELS</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
    
<span class="k">class</span> <span class="nc">ObjectDetect</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">416</span><span class="p">,</span><span class="mi">416</span><span class="p">),</span> <span class="n">min_conf_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">show_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found_bins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_conf_threshold</span> <span class="o">=</span> <span class="n">min_conf_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imW</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imH</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_gui</span> <span class="o">=</span> <span class="n">show_gui</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span> <span class="o">=</span> <span class="n">Interpreter</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">PATH_TO_CKPT</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">allocate_tensors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">get_input_details</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">get_output_details</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'shape'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'shape'</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">floating_model</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'dtype'</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">'StatefulPartitionedCall'</span> <span class="ow">in</span> <span class="n">outname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">videostream</span> <span class="o">=</span> <span class="n">VideoStream</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">getDistanceFromCamera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">):</span> <span class="c1">#in inches</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">knownHeights</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">*</span><span class="mi">462</span><span class="p">)</span><span class="o">/</span><span class="n">height</span>
        
    <span class="k">def</span> <span class="nf">getCenterofObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">):</span> <span class="c1">#in pixels</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">doObjectDetect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">frame1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">videostream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">frame_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">frame_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame_rgb</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">frame_resized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">floating_model</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">set_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'index'</span><span class="p">],</span> <span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">invoke</span><span class="p">()</span>

        <span class="n">boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_details</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes_idx</span><span class="p">][</span><span class="s1">'index'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_details</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">classes_idx</span><span class="p">][</span><span class="s1">'index'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_details</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_idx</span><span class="p">][</span><span class="s1">'index'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">found_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">found_bins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_conf_threshold</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)):</span>

                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imH</span><span class="p">)))</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imW</span><span class="p">)))</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imH</span><span class="p">,(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imH</span><span class="p">)))</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imW</span><span class="p">,(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imW</span><span class="p">)))</span>
                <span class="n">object_name</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDistanceFromCamera</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">)</span>
                <span class="n">x_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCenterofObj</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">imW</span><span class="o">/</span><span class="mi">2</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_gui</span><span class="p">:</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymax</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">object_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">% (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="si">}</span><span class="s2">in)"</span>
                    <span class="n">labelSize</span><span class="p">,</span> <span class="n">baseLine</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTextSize</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">label_ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">labelSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">label_ymin</span><span class="o">-</span><span class="n">labelSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="n">xmin</span><span class="o">+</span><span class="n">labelSize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label_ymin</span><span class="o">+</span><span class="n">baseLine</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">label_ymin</span><span class="o">-</span><span class="mi">7</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="n">object_name</span> <span class="o">==</span> <span class="s2">"drop-bin"</span><span class="p">:</span>
                    <span class="n">found_bin</span> <span class="o">=</span> <span class="p">[</span><span class="n">object_name</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">x_error</span><span class="p">]</span>
                    <span class="n">found_bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found_bin</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">found_object</span> <span class="o">=</span> <span class="p">[</span><span class="n">object_name</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">x_error</span><span class="p">]</span>
                    <span class="n">found_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found_object</span><span class="p">)</span>
                
        <span class="n">found_objects</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#sort found objects by distance, closest is always first in array</span>
        <span class="n">found_bins</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found_objects</span> <span class="o">=</span> <span class="n">found_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found_bins</span> <span class="o">=</span> <span class="n">found_bins</span>
                    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_gui</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">'Object detector'</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">videostream</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</pre></div>
<h3><span class="mw-headline" id="Ultrasonic_Sensor_Hub_Code">Ultrasonic Sensor Hub Code</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=18" title="Edit section: Ultrasonic Sensor Hub Code">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>I used a very undocumented USB Ultrasonic Sensor Controller from <a rel="nofollow" class="external text" href="https://ameridroid.com/products/usb-ultrasonic-sensor-controller">ameriDroid.com</a> so I had to basically write my own driver
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Ultrasonic</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="s1">'/dev/ttyUSB0'</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">EIGHTBITS</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">PARITY_NONE</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">STOPBITS_ONE</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">last_received</span> <span class="o">=</span> <span class="s1">''</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">buffer_string</span> <span class="o">=</span> <span class="s1">''</span>
				
	<span class="k">def</span> <span class="nf">receiveUltra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#receives lastest ultra values from serial </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">buffer_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_string</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
		<span class="k">if</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_string</span><span class="p">:</span>
			<span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">last_received</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">buffer_string</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				
	<span class="k">def</span> <span class="nf">setPins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TRIG</span><span class="p">,</span> <span class="n">ECHO</span><span class="p">):</span>
		<span class="n">string</span> <span class="o">=</span> <span class="s2">"init "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">TRIG</span><span class="p">)</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ECHO</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
		
	<span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span> <span class="c1">#try to get value of specific ultra, if errors then return 0</span>
			<span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_received</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">value</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">return</span> <span class="mi">0</span>
	
	<span class="k">def</span> <span class="nf">UltraAvoidanceSetup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setPins</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> 
		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1">#add waits to avoid ultras from being set to wrong pins</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setPins</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setPins</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setPins</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">"start</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
	
	<span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">"stop</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
		
	<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">"stop</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<h3><span class="mw-headline" id="Servo_Controller_Code">Servo Controller Code</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=19" title="Edit section: Servo Controller Code">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>Originally provided by <a rel="nofollow" class="external text" href="https://www.waveshare.com/wiki/File:Servo_Driver_HAT.7z">waveshare.com</a> but had to be modified to support certain functions like moving servos to specified angles over time and to map angle values to pwm pulses
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">smbus</span>

<span class="k">class</span> <span class="nc">Servo</span><span class="p">:</span>
  <span class="n">__SUBADR1</span>            <span class="o">=</span> <span class="mh">0x02</span>
  <span class="n">__SUBADR2</span>            <span class="o">=</span> <span class="mh">0x03</span>
  <span class="n">__SUBADR3</span>            <span class="o">=</span> <span class="mh">0x04</span>
  <span class="n">__MODE1</span>              <span class="o">=</span> <span class="mh">0x00</span>
  <span class="n">__PRESCALE</span>           <span class="o">=</span> <span class="mh">0xFE</span>
  <span class="n">__LED0_ON_L</span>          <span class="o">=</span> <span class="mh">0x06</span>
  <span class="n">__LED0_ON_H</span>          <span class="o">=</span> <span class="mh">0x07</span>
  <span class="n">__LED0_OFF_L</span>         <span class="o">=</span> <span class="mh">0x08</span>
  <span class="n">__LED0_OFF_H</span>         <span class="o">=</span> <span class="mh">0x09</span>
  <span class="n">__ALLLED_ON_L</span>        <span class="o">=</span> <span class="mh">0xFA</span>
  <span class="n">__ALLLED_ON_H</span>        <span class="o">=</span> <span class="mh">0xFB</span>
  <span class="n">__ALLLED_OFF_L</span>       <span class="o">=</span> <span class="mh">0xFC</span>
  <span class="n">__ALLLED_OFF_H</span>       <span class="o">=</span> <span class="mh">0xFD</span>
  <span class="n">MAX_PW</span> <span class="o">=</span> <span class="mi">2500</span>
  <span class="n">MIN_PW</span> <span class="o">=</span> <span class="mi">500</span>
  <span class="n">_freq</span> <span class="o">=</span> <span class="mi">50</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">smbus</span><span class="o">.</span><span class="n">SMBus</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_angle</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"Reseting PCA9685"</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__MODE1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPWMFreq</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hasObject</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
	
  <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="s2">"Writes an 8-bit value to the specified register/address"</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">write_byte_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"I2C: Write 0x</span><span class="si">%02X</span><span class="s2"> to register 0x</span><span class="si">%02X</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
	  
  <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
    <span class="s2">"Read an unsigned byte from the I2C device"</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">read_byte_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"I2C: Device 0x</span><span class="si">%02X</span><span class="s2"> returned 0x</span><span class="si">%02X</span><span class="s2"> from reg 0x</span><span class="si">%02X</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>
	
  <span class="k">def</span> <span class="nf">setPWMFreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
    <span class="s2">"Sets the PWM frequency"</span>
    <span class="n">prescaleval</span> <span class="o">=</span> <span class="mf">25000000.0</span>    <span class="c1"># 25MHz</span>
    <span class="n">prescaleval</span> <span class="o">/=</span> <span class="mf">4096.0</span>       <span class="c1"># 12-bit</span>
    <span class="n">prescaleval</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">prescaleval</span> <span class="o">-=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"Setting PWM frequency to </span><span class="si">%d</span><span class="s2"> Hz"</span> <span class="o">%</span> <span class="n">freq</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"Estimated pre-scale: </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">prescaleval</span><span class="p">)</span>
    <span class="n">prescale</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">prescaleval</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"Final pre-scale: </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">prescale</span><span class="p">)</span>

    <span class="n">oldmode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__MODE1</span><span class="p">);</span>
    <span class="n">newmode</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldmode</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span>        <span class="c1"># sleep</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__MODE1</span><span class="p">,</span> <span class="n">newmode</span><span class="p">)</span>        <span class="c1"># go to sleep</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__PRESCALE</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">prescale</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__MODE1</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__MODE1</span><span class="p">,</span> <span class="n">oldmode</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">setPWM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="n">off</span><span class="p">):</span>
    <span class="s2">"Sets a single PWM channel"</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__LED0_ON_L</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="n">on</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__LED0_ON_H</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="n">on</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__LED0_OFF_L</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__LED0_OFF_H</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"channel: </span><span class="si">%d</span><span class="s2">  LED_ON: </span><span class="si">%d</span><span class="s2"> LED_OFF: </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">on</span><span class="p">,</span><span class="n">off</span><span class="p">))</span>
	  
  <span class="k">def</span> <span class="nf">setServoPulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">pulse</span><span class="p">):</span>
    <span class="s2">"Sets the Servo Pulse,The PWM frequency must be 50HZ"</span>
    <span class="n">pulse</span> <span class="o">=</span> <span class="n">pulse</span><span class="o">*</span><span class="mi">4096</span><span class="o">/</span><span class="mi">20000</span>        <span class="c1">#PWM frequency is 50HZ,the period is 20000us</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPWM</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pulse</span><span class="p">))</span>
  
  <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">in_min</span><span class="p">,</span> <span class="n">in_max</span><span class="p">,</span> <span class="n">out_min</span><span class="p">,</span> <span class="n">out_max</span><span class="p">):</span> <span class="c1">#map angle value to pwm value</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">in_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">out_max</span> <span class="o">-</span> <span class="n">out_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">in_max</span> <span class="o">-</span> <span class="n">in_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">out_min</span>
    
  <span class="k">def</span> <span class="nf">angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Angle value should be int or float value, not </span><span class="si">%s</span><span class="s2">"</span><span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span>
    <span class="k">if</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="mi">90</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_angle</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="n">High_level_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_PW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_PW</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setServoPulse</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">High_level_time</span><span class="p">)</span>
    
  <span class="k">def</span> <span class="nf">moveto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">speed</span><span class="p">):</span>
    <span class="n">last_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_angle</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_angle</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"moving channel&nbsp;:"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">"last angle: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_angle</span><span class="p">))</span>
    
    <span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">last_angle</span><span class="p">:</span>
      <span class="n">steps</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_angle</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">steps</span><span class="p">)</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
      
  <span class="k">def</span> <span class="nf">doPickup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    
  <span class="k">def</span> <span class="nf">doDrop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
</pre></div>
<h3><span class="mw-headline" id="Motor_Controller_Code">Motor Controller Code</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=20" title="Edit section: Motor Controller Code">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>Originally provided by <a rel="nofollow" class="external text" href="http://osoyoo.com/driver/mecanum/modelpi.py">osoyoo.com</a> but had to be modified to support python classes as well as adding an option to use both wheels or not when turning
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="kn">import</span> <span class="nn">RPi.GPIO</span> <span class="k">as</span> <span class="nn">GPIO</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="k">class</span> <span class="nc">Motor</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">IN1</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">IN2</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">IN3</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="n">IN4</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">ENA</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ENB</span> <span class="o">=</span> <span class="mi">33</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">IN1</span> <span class="o">=</span> <span class="n">IN1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">IN2</span> <span class="o">=</span> <span class="n">IN2</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">IN3</span> <span class="o">=</span> <span class="n">IN3</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">IN4</span> <span class="o">=</span> <span class="n">IN4</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ENA</span> <span class="o">=</span> <span class="n">ENA</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ENB</span> <span class="o">=</span> <span class="n">ENB</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">GPIO</span><span class="o">.</span><span class="n">BOARD</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN1</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN2</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN3</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN4</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ENA</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ENB</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rightmotor</span> <span class="o">=</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">PWM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ENA</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>	
		<span class="bp">self</span><span class="o">.</span><span class="n">leftmotor</span> <span class="o">=</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">PWM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ENB</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>	
		<span class="bp">self</span><span class="o">.</span><span class="n">rightmotor</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">leftmotor</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isMoving</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="o">=</span><span class="n">disable</span>
		
	<span class="k">def</span> <span class="nf">go_foward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN2</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN3</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span> 
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN4</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rightmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">leftmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isMoving</span> <span class="o">=</span> <span class="kc">True</span>
	
	<span class="k">def</span> <span class="nf">go_backwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN1</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN2</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN3</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN4</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rightmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">leftmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isMoving</span> <span class="o">=</span> <span class="kc">True</span>
		
	<span class="k">def</span> <span class="nf">turn_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="n">both_wheels</span><span class="p">:</span>	
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN1</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN2</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN3</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN4</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">leftmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rightmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN2</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN3</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN4</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">leftmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isMoving</span> <span class="o">=</span> <span class="kc">True</span>
		
	<span class="k">def</span> <span class="nf">turn_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">both_wheels</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="n">both_wheels</span><span class="p">:</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN2</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN3</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN4</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rightmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">leftmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN2</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN4</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN3</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rightmotor</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isMoving</span> <span class="o">=</span> <span class="kc">True</span>
		
	<span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1">#print("Stopping motor")</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN2</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN3</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IN4</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isMoving</span> <span class="o">=</span> <span class="kc">False</span>
		
	<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
		<span class="n">GPIO</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</pre></div>
<h3><span class="mw-headline" id="LCD_Driver">LCD Driver</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=21" title="Edit section: LCD Driver">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>Originally provided by the <a rel="nofollow" class="external text" href="https://github.com/the-raspberry-pi-guy/lcd/blob/master/drivers/i2c_dev.py">Raspberry Pi Guy</a> but removed unnecessary functions
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="kn">from</span> <span class="nn">smbus</span> <span class="kn">import</span> <span class="n">SMBus</span>
<span class="kn">from</span> <span class="nn">RPi.GPIO</span> <span class="kn">import</span> <span class="n">RPI_REVISION</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">findall</span><span class="p">,</span> <span class="n">match</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">check_output</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>

<span class="c1"># old and new versions of the RPi have swapped the two i2c buses</span>
<span class="c1"># they can be identified by RPI_REVISION (or check sysfs)</span>
<span class="n">BUS_NUMBER</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">RPI_REVISION</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># other commands</span>
<span class="n">LCD_CLEARDISPLAY</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="n">LCD_RETURNHOME</span> <span class="o">=</span> <span class="mh">0x02</span>
<span class="n">LCD_ENTRYMODESET</span> <span class="o">=</span> <span class="mh">0x04</span>
<span class="n">LCD_DISPLAYCONTROL</span> <span class="o">=</span> <span class="mh">0x08</span>
<span class="n">LCD_CURSORSHIFT</span> <span class="o">=</span> <span class="mh">0x10</span>
<span class="n">LCD_FUNCTIONSET</span> <span class="o">=</span> <span class="mh">0x20</span>
<span class="n">LCD_SETCGRAMADDR</span> <span class="o">=</span> <span class="mh">0x40</span>
<span class="n">LCD_SETDDRAMADDR</span> <span class="o">=</span> <span class="mh">0x80</span>

<span class="c1"># flags for display entry mode</span>
<span class="n">LCD_ENTRYRIGHT</span> <span class="o">=</span> <span class="mh">0x00</span>
<span class="n">LCD_ENTRYLEFT</span> <span class="o">=</span> <span class="mh">0x02</span>
<span class="n">LCD_ENTRYSHIFTINCREMENT</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="n">LCD_ENTRYSHIFTDECREMENT</span> <span class="o">=</span> <span class="mh">0x00</span>

<span class="c1"># flags for display on/off control</span>
<span class="n">LCD_DISPLAYON</span> <span class="o">=</span> <span class="mh">0x04</span>
<span class="n">LCD_DISPLAYOFF</span> <span class="o">=</span> <span class="mh">0x00</span>
<span class="n">LCD_CURSORON</span> <span class="o">=</span> <span class="mh">0x02</span>
<span class="n">LCD_CURSOROFF</span> <span class="o">=</span> <span class="mh">0x00</span>
<span class="n">LCD_BLINKON</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="n">LCD_BLINKOFF</span> <span class="o">=</span> <span class="mh">0x00</span>

<span class="c1"># flags for display/cursor shift</span>
<span class="n">LCD_DISPLAYMOVE</span> <span class="o">=</span> <span class="mh">0x08</span>
<span class="n">LCD_CURSORMOVE</span> <span class="o">=</span> <span class="mh">0x00</span>
<span class="n">LCD_MOVERIGHT</span> <span class="o">=</span> <span class="mh">0x04</span>
<span class="n">LCD_MOVELEFT</span> <span class="o">=</span> <span class="mh">0x00</span>

<span class="c1"># flags for function set</span>
<span class="n">LCD_8BITMODE</span> <span class="o">=</span> <span class="mh">0x10</span>
<span class="n">LCD_4BITMODE</span> <span class="o">=</span> <span class="mh">0x00</span>
<span class="n">LCD_2LINE</span> <span class="o">=</span> <span class="mh">0x08</span>
<span class="n">LCD_1LINE</span> <span class="o">=</span> <span class="mh">0x00</span>
<span class="n">LCD_5x10DOTS</span> <span class="o">=</span> <span class="mh">0x04</span>
<span class="n">LCD_5x8DOTS</span> <span class="o">=</span> <span class="mh">0x00</span>

<span class="c1"># flags for backlight control</span>
<span class="n">LCD_BACKLIGHT</span> <span class="o">=</span> <span class="mh">0x08</span>
<span class="n">LCD_NOBACKLIGHT</span> <span class="o">=</span> <span class="mh">0x00</span>

<span class="n">En</span> <span class="o">=</span> <span class="mb">0b00000100</span>  <span class="c1"># Enable bit</span>
<span class="n">Rw</span> <span class="o">=</span> <span class="mb">0b00000010</span>  <span class="c1"># Read/Write bit</span>
<span class="n">Rs</span> <span class="o">=</span> <span class="mb">0b00000001</span>  <span class="c1"># Register select bit</span>

<span class="k">class</span> <span class="nc">I2CDevice</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">addr_default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bus</span><span class="o">=</span><span class="n">BUS_NUMBER</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span><span class="p">:</span>
            <span class="c1"># try autodetect address, else use default if provided</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">'0x</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">findall</span><span class="p">(</span><span class="s2">"[0-9a-z]</span><span class="si">{2}</span><span class="s2">(?!:)"</span><span class="p">,</span> <span class="n">check_output</span><span class="p">([</span><span class="s1">'/usr/sbin/i2cdetect'</span><span class="p">,</span> <span class="s1">'-y'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">BUS_NUMBER</span><span class="p">)])</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="s1">'/usr/sbin/i2cdetect'</span><span class="p">)</span> <span class="k">else</span> <span class="n">addr_default</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr_default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">SMBus</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span>

    <span class="c1"># write a single command</span>
    <span class="k">def</span> <span class="nf">write_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>

    <span class="c1"># write a command and argument</span>
    <span class="k">def</span> <span class="nf">write_cmd_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">write_byte_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>

    <span class="c1"># write a block of data</span>
    <span class="k">def</span> <span class="nf">write_block_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">write_block_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>

    <span class="c1"># read a single byte</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>

    <span class="c1"># read</span>
    <span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">read_byte_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="c1"># read a block of data</span>
    <span class="k">def</span> <span class="nf">read_block_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">read_block_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LCD</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span> <span class="o">=</span> <span class="n">I2CDevice</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr_default</span><span class="o">=</span><span class="mh">0x27</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x03</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x03</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x03</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="n">LCD_FUNCTIONSET</span> <span class="o">|</span> <span class="n">LCD_2LINE</span> <span class="o">|</span> <span class="n">LCD_5x8DOTS</span> <span class="o">|</span> <span class="n">LCD_4BITMODE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="n">LCD_DISPLAYCONTROL</span> <span class="o">|</span> <span class="n">LCD_DISPLAYON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="n">LCD_CLEARDISPLAY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="n">LCD_ENTRYMODESET</span> <span class="o">|</span> <span class="n">LCD_ENTRYLEFT</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="c1"># clocks EN to latch command</span>
    <span class="k">def</span> <span class="nf">lcd_strobe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">write_cmd</span><span class="p">(</span><span class="n">data</span> <span class="o">|</span> <span class="n">En</span> <span class="o">|</span> <span class="n">LCD_BACKLIGHT</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">.0005</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">write_cmd</span><span class="p">(((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">En</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCD_BACKLIGHT</span><span class="p">))</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">.0001</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lcd_write_four_bits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">write_cmd</span><span class="p">(</span><span class="n">data</span> <span class="o">|</span> <span class="n">LCD_BACKLIGHT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_strobe</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># write a command to lcd</span>
    <span class="k">def</span> <span class="nf">lcd_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write_four_bits</span><span class="p">(</span><span class="n">mode</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write_four_bits</span><span class="p">(</span><span class="n">mode</span> <span class="o">|</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">))</span>

    <span class="c1"># put string function</span>
    <span class="k">def</span> <span class="nf">lcd_display_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0xC0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x94</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0xD4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">),</span> <span class="n">Rs</span><span class="p">)</span>

    <span class="c1"># put extended string function. Extended string may contain placeholder like {0xFF} for </span>
    <span class="c1"># displaying the particular symbol from the symbol table</span>
    <span class="k">def</span> <span class="nf">lcd_display_extended_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0xC0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0x94</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="mh">0xD4</span><span class="p">)</span>
        <span class="c1"># Process the string</span>
        <span class="k">while</span> <span class="n">string</span><span class="p">:</span>
            <span class="c1"># Trying to find pattern {0xFF} representing a symbol</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\{0[xX][0-9a-fA-F]</span><span class="si">{2}</span><span class="s1">\}'</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="n">Rs</span><span class="p">)</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">Rs</span><span class="p">)</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># clear lcd and set to home</span>
    <span class="k">def</span> <span class="nf">lcd_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="n">LCD_CLEARDISPLAY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd_write</span><span class="p">(</span><span class="n">LCD_RETURNHOME</span><span class="p">)</span>

    <span class="c1"># backlight control (on/off)</span>
    <span class="c1"># options: lcd_backlight(1) = ON, lcd_backlight(0) = OFF</span>
    <span class="k">def</span> <span class="nf">lcd_backlight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">write_cmd</span><span class="p">(</span><span class="n">LCD_BACKLIGHT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="o">.</span><span class="n">write_cmd</span><span class="p">(</span><span class="n">LCD_NOBACKLIGHT</span><span class="p">)</span>
</pre></div>
<h2><span class="mw-headline" id="Video_of_the_Robot">Video of the Robot</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=22" title="Edit section: Video of the Robot">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p><big>
<big>
<big>
<big>
<a rel="nofollow" class="external text" href="https://www.youtube.com/watch?v=V7nuHL4opsM">BarkBot Video Demonstration</a>
</big>
</big>
</big>
</big>
</p>
<h2><span class="mw-headline" id="Photos_of_the_Robot">Photos of the Robot</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit&amp;section=23" title="Edit section: Photos of the Robot">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p><a href="https://eti4480.com/2023/index.php/File:BarkBot1.JPEG" class="image"><img alt="BarkBot1.JPEG" src="./BarkBot - Applied Robotics 2023 Class Wiki!_files/600px-BarkBot1.JPEG" decoding="async" width="600" height="450" srcset="/2023/images/thumb/4/4c/BarkBot1.JPEG/900px-BarkBot1.JPEG 1.5x, /2023/images/thumb/4/4c/BarkBot1.JPEG/1200px-BarkBot1.JPEG 2x"></a>
<a href="https://eti4480.com/2023/index.php/File:BarkBot2.JPEG" class="image"><img alt="BarkBot2.JPEG" src="./BarkBot - Applied Robotics 2023 Class Wiki!_files/600px-BarkBot2.JPEG" decoding="async" width="600" height="450" srcset="/2023/images/thumb/9/9e/BarkBot2.JPEG/900px-BarkBot2.JPEG 1.5x, /2023/images/thumb/9/9e/BarkBot2.JPEG/1200px-BarkBot2.JPEG 2x"></a>
<a href="https://eti4480.com/2023/index.php/File:BarkBot3.JPEG" class="image"><img alt="BarkBot3.JPEG" src="./BarkBot - Applied Robotics 2023 Class Wiki!_files/600px-BarkBot3.JPEG" decoding="async" width="600" height="450" srcset="/2023/images/thumb/5/5f/BarkBot3.JPEG/900px-BarkBot3.JPEG 1.5x, /2023/images/thumb/5/5f/BarkBot3.JPEG/1200px-BarkBot3.JPEG 2x"></a>
<a href="https://eti4480.com/2023/index.php/File:BarkBot4.JPEG" class="image"><img alt="BarkBot4.JPEG" src="./BarkBot - Applied Robotics 2023 Class Wiki!_files/600px-BarkBot4.JPEG" decoding="async" width="600" height="450" srcset="/2023/images/thumb/1/10/BarkBot4.JPEG/900px-BarkBot4.JPEG 1.5x, /2023/images/thumb/1/10/BarkBot4.JPEG/1200px-BarkBot4.JPEG 2x"></a>
</p>
<!-- 
NewPP limit report
Cached time: 20230803051234
Cache expiry: 86400
Reduced expiry: false
Complications: []
CPU time usage: 0.250 seconds
Real time usage: 1.582 seconds
Preprocessor visited node count: 123/1000000
Postexpand include size: 1643/2097152 bytes
Template argument size: 142/2097152 bytes
Highest expansion depth: 3/100
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip postexpand size: 179712/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    5.240      1 Template:Infobox_Robot
100.00%    5.240      1 -total
-->

<!-- Saved in parser cache with key dbelpptymcc6gl-soft_:pcache:idhash:123-0!canonical and timestamp 20230803051232 and revision id 1456. Serialized with JSON.
 -->
</div>
<div class="printfooter">Retrieved from "<a dir="ltr" href="https://eti4480.com/2023/index.php?title=BarkBot&amp;oldid=1456">https://eti4480.com/2023/index.php?title=BarkBot&amp;oldid=1456</a>"</div></div>
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="https://eti4480.com/2023/index.php/Special:Categories" title="Special:Categories">Category</a>: <ul><li><a href="https://eti4480.com/2023/index.php?title=Category:Pages_using_deprecated_source_tags&amp;action=edit&amp;redlink=1" class="new" title="Category:Pages using deprecated source tags (page does not exist)">Pages using deprecated source tags</a></li></ul></div></div>
	</div>
</div>

<div id="mw-navigation">
	<h2>Navigation menu</h2>
	<div id="mw-head">
		
<nav id="p-personal" class="mw-portlet mw-portlet-personal vector-user-menu-legacy vector-menu" aria-labelledby="p-personal-label" role="navigation">
	<label id="p-personal-label" aria-label="" class="vector-menu-heading">
		<span class="vector-menu-heading-label">Personal tools</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="pt-userpage" class="mw-list-item"><a class="new" href="https://eti4480.com/2023/index.php/User:Brad" dir="auto" title="Your user page (page does not exist) [alt-shift-.]" accesskey="."><span>Brad</span></a></li><li id="pt-mytalk" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/User_talk:Brad" class="new" title="Your talk page (page does not exist) [alt-shift-n]" accesskey="n"><span>Talk</span></a></li><li id="pt-preferences" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:Preferences" title="Your preferences"><span>Preferences</span></a></li><li id="pt-watchlist" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:Watchlist" title="A list of pages you are monitoring for changes [alt-shift-l]" accesskey="l"><span>Watchlist</span></a></li><li id="pt-mycontris" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:Contributions/Brad" title="A list of your contributions [alt-shift-y]" accesskey="y"><span>Contributions</span></a></li><li id="pt-logout" class="mw-list-item"><a href="https://eti4480.com/2023/index.php?title=Special:UserLogout&amp;returnto=BarkBot" data-mw="interface" title="Log out"><span>Log out</span></a></li></ul>
		
	</div>
</nav>

		<div id="left-navigation">
			
<nav id="p-namespaces" class="mw-portlet mw-portlet-namespaces vector-menu vector-menu-tabs" aria-labelledby="p-namespaces-label" role="navigation">
	<label id="p-namespaces-label" aria-label="" class="vector-menu-heading">
		<span class="vector-menu-heading-label">Namespaces</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-nstab-main" class="selected mw-list-item"><a href="https://eti4480.com/2023/index.php/BarkBot" title="View the content page [alt-shift-c]" accesskey="c"><span>Page</span></a></li><li id="ca-talk" class="new mw-list-item"><a href="https://eti4480.com/2023/index.php?title=Talk:BarkBot&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [alt-shift-t]" accesskey="t"><span>Discussion</span></a></li></ul>
		
	</div>
</nav>

			
<nav id="p-variants" class="mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown-noicon vector-menu vector-menu-dropdown" aria-labelledby="p-variants-label" role="navigation">
	<input type="checkbox" id="p-variants-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-variants" class="vector-menu-checkbox" aria-labelledby="p-variants-label">
	<label id="p-variants-label" aria-label="Change language variant" class="vector-menu-heading">
		<span class="vector-menu-heading-label">English</span>
			<span class="vector-menu-checkbox-expanded">expanded</span>
			<span class="vector-menu-checkbox-collapsed">collapsed</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

		</div>
		<div id="right-navigation">
			
<nav id="p-views" class="mw-portlet mw-portlet-views vector-menu vector-menu-tabs" aria-labelledby="p-views-label" role="navigation">
	<label id="p-views-label" aria-label="" class="vector-menu-heading">
		<span class="vector-menu-heading-label">Views</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-view" class="selected mw-list-item collapsible"><a href="https://eti4480.com/2023/index.php/BarkBot"><span>Read</span></a></li><li id="ca-edit" class="mw-list-item collapsible"><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=edit" title="Edit this page [alt-shift-e]" accesskey="e"><span>Edit</span></a></li><li id="ca-history" class="mw-list-item collapsible"><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=history" title="Past revisions of this page [alt-shift-h]" accesskey="h"><span>View history</span></a></li><li id="ca-unwatch" class="mw-watchlink icon mw-list-item"><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=unwatch" data-mw="interface" title="Remove this page from your watchlist [alt-shift-w]" accesskey="w" aria-controls="mw-watchlink-notification"><span>Unwatch</span></a></li></ul>
		
	</div>
</nav>

			
<nav id="p-cactions" class="mw-portlet mw-portlet-cactions vector-menu-dropdown-noicon vector-menu vector-menu-dropdown" aria-labelledby="p-cactions-label" role="navigation" title="More options">
	<input type="checkbox" id="p-cactions-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-cactions" class="vector-menu-checkbox" aria-labelledby="p-cactions-label">
	<label id="p-cactions-label" aria-label="" class="vector-menu-heading">
		<span class="vector-menu-heading-label">More</span>
			<span class="vector-menu-checkbox-expanded">expanded</span>
			<span class="vector-menu-checkbox-collapsed">collapsed</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-move" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:MovePage/BarkBot" title="Move this page [alt-shift-m]" accesskey="m"><span>Move</span></a></li></ul>
		
	</div>
</nav>

			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<div>
			<h3>
				<label for="searchInput">Search</label>
			</h3>
		<form action="https://eti4480.com/2023/index.php" id="searchform" class="vector-search-box-form">
			<div id="simpleSearch" class="vector-search-box-inner" data-search-loc="header-navigation">
				<input class="vector-search-box-input" type="search" name="search" placeholder="Search Applied Robotics 2023 Class Wiki!" aria-label="Search Applied Robotics 2023 Class Wiki!" autocapitalize="sentences" title="Search Applied Robotics 2023 Class Wiki! [alt-shift-f]" accesskey="f" id="searchInput">
				<input type="hidden" name="title" value="Special:Search">
				<input id="mw-searchButton" class="searchButton mw-fallbackSearchButton" type="submit" name="fulltext" title="Search the pages for this text" value="Search">
				<input id="searchButton" class="searchButton" type="submit" name="go" title="Go to a page with this exact name if it exists" value="Go">
			</div>
		</form>
	</div>
</div>

		</div>
	</div>
	

<div id="mw-panel">
	<div id="p-logo" role="banner">
		<a class="mw-wiki-logo" href="https://eti4480.com/2023/index.php/Main_Page" title="Visit the main page"></a>
	</div>
	
<nav id="p-navigation" class="mw-portlet mw-portlet-navigation vector-menu vector-menu-portal portal" aria-labelledby="p-navigation-label" role="navigation">
	<label id="p-navigation-label" aria-label="" class="vector-menu-heading">
		<span class="vector-menu-heading-label">Navigation</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-mainpage-description" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Main_Page" icon="home" title="Visit the main page [alt-shift-z]" accesskey="z"><span>Main page</span></a></li><li id="n-recentchanges" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:RecentChanges" icon="recentChanges" title="A list of recent changes in the wiki [alt-shift-r]" accesskey="r"><span>Recent changes</span></a></li><li id="n-randompage" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:Random" icon="die" title="Load a random page [alt-shift-x]" accesskey="x"><span>Random page</span></a></li><li id="n-help-mediawiki" class="mw-list-item"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents"><span>Help about MediaWiki</span></a></li></ul>
		
	</div>
</nav>

	
<nav id="p-tb" class="mw-portlet mw-portlet-tb vector-menu vector-menu-portal portal" aria-labelledby="p-tb-label" role="navigation">
	<label id="p-tb-label" aria-label="" class="vector-menu-heading">
		<span class="vector-menu-heading-label">Tools</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="t-whatlinkshere" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:WhatLinksHere/BarkBot" title="A list of all wiki pages that link here [alt-shift-j]" accesskey="j"><span>What links here</span></a></li><li id="t-recentchangeslinked" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:RecentChangesLinked/BarkBot" rel="nofollow" title="Recent changes in pages linked from this page [alt-shift-k]" accesskey="k"><span>Related changes</span></a></li><li id="t-upload" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:Upload" title="Upload files [alt-shift-u]" accesskey="u"><span>Upload file</span></a></li><li id="t-specialpages" class="mw-list-item"><a href="https://eti4480.com/2023/index.php/Special:SpecialPages" title="A list of all special pages [alt-shift-q]" accesskey="q"><span>Special pages</span></a></li><li id="t-print" class="mw-list-item"><a href="javascript:print();" rel="alternate" title="Printable version of this page [alt-shift-p]" accesskey="p"><span>Printable version</span></a></li><li id="t-permalink" class="mw-list-item"><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;oldid=1456" title="Permanent link to this revision of the page"><span>Permanent link</span></a></li><li id="t-info" class="mw-list-item"><a href="https://eti4480.com/2023/index.php?title=BarkBot&amp;action=info" title="More information about this page"><span>Page information</span></a></li></ul>
		
	</div>
</nav>

	
</div>

</div>

<footer id="footer" class="mw-footer" role="contentinfo">
	<ul id="footer-info">
	<li id="footer-info-lastmod"> This page was last edited on 17 April 2023, at 12:34.</li>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://eti4480.com/2023/index.php/Wiki_Name:Privacy_policy" title="Wiki Name:Privacy policy">Privacy policy</a></li>
	<li id="footer-places-about"><a href="https://eti4480.com/2023/index.php/Wiki_Name:About" title="Wiki Name:About">About Applied Robotics 2023 Class Wiki!</a></li>
	<li id="footer-places-disclaimer"><a href="https://eti4480.com/2023/index.php/Wiki_Name:General_disclaimer" title="Wiki Name:General disclaimer">Disclaimers</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="./BarkBot - Applied Robotics 2023 Class Wiki!_files/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="/2023/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /2023/resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></a></li>
</ul>

</footer>

<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.250","walltime":"1.582","ppvisitednodes":{"value":123,"limit":1000000},"postexpandincludesize":{"value":1643,"limit":2097152},"templateargumentsize":{"value":142,"limit":2097152},"expansiondepth":{"value":3,"limit":100},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":179712,"limit":5000000},"timingprofile":["100.00%    5.240      1 Template:Infobox_Robot","100.00%    5.240      1 -total"]},"cachereport":{"timestamp":"20230803051234","ttl":86400,"transientcontent":false}}});mw.config.set({"wgBackendResponseTime":1758});});</script>

</body></html>